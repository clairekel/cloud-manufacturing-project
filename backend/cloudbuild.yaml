steps:
  - name: 'python:3.9'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Install Google Cloud SDK
        echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
        apt-get update && apt-get install -y google-cloud-sdk

        # Print Python version
        python --version

        # Print current project
        echo "Current Project ID:"
        gcloud config get-value project

        # Access the secret (we'll skip listing all secrets)
        echo "Accessing Firestore credentials..."
        gcloud secrets versions access latest --secret=firestore-secret > /tmp/firestore-credentials.json

        # Set the credentials for use in tests
        export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firestore-credentials.json

        # Navigate to the backend directory
        cd backend

        # Install dependencies
        echo "Installing dependencies..."
        pip install -r requirements.txt

        # Run tests
        echo "Running tests..."
        python -m pytest test.py

# Set the timeout for the build (optional)
timeout: '1800s'

# Use Cloud Logging
options:
  logging: CLOUD_LOGGING_ONLY