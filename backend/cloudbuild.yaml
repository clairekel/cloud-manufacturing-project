steps:
  - name: 'python:3.9'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Project ID: $PROJECT_ID"
        echo "CLOUD_BUILD_PROJECT_ID: $CLOUD_BUILD_PROJECT_ID"
        echo "All environment variables:"
        env
        cd backend
        pip install -r requirements.txt
        pip install python-dotenv google-cloud-secret-manager
        python -c "
        import os
        from google.cloud import secretmanager
        client = secretmanager.SecretManagerServiceClient()
        project_id = os.environ.get('PROJECT_ID')
        print(f'Accessing secrets for project: {project_id}')
        name = f'projects/{project_id}/secrets/project_id/versions/latest'
        try:
            response = client.access_secret_version(request={'name': name})
            print('Successfully accessed secret')
        except Exception as e:
            print(f'Error accessing secret: {e}')
        "
        python test.py
    secretEnv: ['PROJECT_ID', 'SECRET_ID']

availableSecrets:
  secretManager:
  - versionName: projects/$PROJECT_ID/secrets/project_id/versions/latest
    env: 'PROJECT_ID'
  - versionName: projects/$PROJECT_ID/secrets/secret_id/versions/latest
    env: 'SECRET_ID'

options:
  logging: CLOUD_LOGGING_ONLY